<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Openshift - Working with vSphere Storage Classes | KryoLogs</title><meta property="og:title" content="Openshift - Working with vSphere Storage Classes | KryoLogs"><meta name=twitter:title content="Openshift - Working with vSphere Storage Classes | KryoLogs"><meta itemprop=name content="Openshift - Working with vSphere Storage Classes | KryoLogs"><meta name=application-name content="Openshift - Working with vSphere Storage Classes | KryoLogs"><meta property="og:site_name" content="KryoLogs"><meta name=description content="Modifing and setting datastores on storage classes."><meta itemprop=description content="Modifing and setting datastores on storage classes."><meta property="og:description" content="Modifing and setting datastores on storage classes."><meta name=twitter:description content="Modifing and setting datastores on storage classes."><meta property="og:locale" content="en-us"><meta name=language content="en-us"><meta itemprop=image content="https://KalebHawkins.github.io/KryoLogs"><meta property="og:image" content="https://KalebHawkins.github.io/KryoLogs"><meta name=twitter:image content="https://KalebHawkins.github.io/KryoLogs"><meta name=twitter:image:src content="https://KalebHawkins.github.io/KryoLogs"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2023-04-14T00:00:00Z"><meta property="article:published_time" content="2023-04-14T00:00:00Z"><meta property="og:article:author" content="Kaleb hawkins"><meta property="article:author" content="Kaleb hawkins"><meta name=author content="Kaleb hawkins"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Openshift - Working with vSphere Storage Classes","author":{"@type":"Person","name":""},"datePublished":"2023-04-14","description":"Modifing and setting datastores on storage classes.","wordCount":483,"mainEntityOfPage":"True","dateModified":"2023-04-14","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"KryoLogs"}}</script><meta name=generator content="Hugo 0.110.0"><link rel=canonical href=https://KalebHawkins.github.io/KryoLogs/posts/openshift/vsphere-storageclasses/><link href=/KryoLogs/sass/main.min.0eebb6db90b4ec9f4444ef402f08421ee056025ba860df3d749a9f299d472008.css rel=stylesheet><link href=/KryoLogs/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/images/favicon/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon/favicon-16x16.png><link rel=manifest href=/images/favicon/site.webmanifest><link rel=mask-icon href=/images/favicon/safari-pinned-tab.svg color=#5bbad5><link rel="shortcut icon" href=/images/favicon/favicon.ico><meta name=msapplication-TileColor content="#2b5797"><meta name=msapplication-config content="/images/favicon/browserconfig.xml"><meta name=theme-color content="#ffffff"><link rel=icon type=image/svg+xml href=/images/favicon/favicon.svg></head><body data-theme=dark class=notransition><script src=https://KalebHawkins.github.io/KryoLogs/js/themeLoader.min.4e9e1a253d543bbfec02e7f2460d9621e719fd739dc8a5256faa91cda6e12e03.js></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=/KryoLogs/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/KryoLogs/>Home</a></li><li><a class="menu-link active" href=/KryoLogs/posts/>Posts</a></li><li><a class=menu-link href=/KryoLogs/about/>About</a></li><li class=menu-separator><span>|</span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Openshift - Working with vSphere Storage Classes</h1><div class=post-meta><time datetime=2023-04-14T00:00:00+00:00 itemprop=datePublished>Apr 14, 2023</time></div></header><div class=page-content><p>In this post we are going to look at two different things. First, we will look at modifing the default datastore for our vsphere storage class. Second, we will look at creating storage classes that specify the datastore.</p><h2 id=the-default-datastore>The Default Datastore</h2><blockquote><p>This change will trigger the nodes to reboot. Always make sure you are in an open maintenaince window or that your applications are designed to work through pods migrating from node to node for less impact.</p></blockquote><p>The default datastore is located in a configmap. This configmap is called <code>cloud-provider-config</code>. This configmap can be found in the <code>openshift-config</code> namespace. We can view it using the following command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>oc get cm cloud-provider-config -n openshift-config -o yaml
</span></span></code></pre></div><p>You can then modify the <code>default-datastore</code> entry by editing the yaml.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>oc edit cm cloud-provider-config -n openshift-config
</span></span></code></pre></div><p>This will trigger the <code>kube-controller-manager</code> cluster operator to start updating which will cause the cluster nodes to reboot. This will cause other cluster operators to update as the master nodes roll over. This can take variable amount of time to complete depending on the size of the cluster. As long as everything is pprogressing you are OK ðŸ˜¬. You can watch the cluster update using the command below. You may have to reauthenticate at some point but again all should be fine. There is little to no application impact. The only impact is when the pods are moving from node to node and depending on the application design this may or may not be an issue.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>watch oc get co
</span></span></code></pre></div><p>Once all of that is done you can verify the change by looking at the <code>cloud-conf</code> configmap in the <code>openshift-cloud-controller-manager</code> namespace.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>oc get cm -n openshift-cloud-controller-manager -o yaml
</span></span></code></pre></div><p>Test provisioning of a new PV as well. Make sure it get placed in the right place. Make your <code>custom resource definition (CRD)</code> and apply it to the cluster using whatever method you use for cluster or application config, gitops, etc. For this demo I&rsquo;ll use <code>kubectl</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># filename: new-pvc.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;name-of-pvc&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>&lt;name-of-namespace&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>&lt;storageclass-name&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMode</span><span class=p>:</span><span class=w> </span><span class=l>Filesystem</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f new-pvc.yaml
</span></span></code></pre></div><h2 id=specify-datastores-at-the-storageclass-level>Specify Datastores at the StorageClass Level</h2><p>You will need to create a CRD to create the storageclass and apply it to the cluster. The CRD is just a yaml file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># filename: sc-custom-ds.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;storage-class-name&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/description</span><span class=p>:</span><span class=w> </span><span class=l>A good description for your storageclass </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storageclass.kubernetes.io/is-default-class</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/vsphere-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>datastore</span><span class=p>:</span><span class=w> </span><span class=l>&lt;datastore-name&gt;</span><span class=w> </span><span class=c># &lt;- Here is where you specify your datastore.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>diskformat</span><span class=p>:</span><span class=w> </span><span class=l>eagerzeroedthick</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>reclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w> </span><span class=c># &lt;- Modify this depending on your policies (see references for more info)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeBindingMode</span><span class=p>:</span><span class=w> </span><span class=l>Immediate</span><span class=w>
</span></span></span></code></pre></div><p>Now you can apply the CRD to the cluster.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f sc-custom-ds.yaml
</span></span></code></pre></div><p>That is all there is to it. Now, when you create your <code>PVs</code> against the specified storage class they will use the datastore provided in the configuration.</p><h2 id=references>References</h2><ul><li><a href=https://access.redhat.com/solutions/4618011>Default Datastore</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/storage-classes/>Reclaim Policies</a></li></ul></div></article></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/KalebHawkins target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.tiktok.com/@kryotek target=_blank rel="noopener noreferrer me" title=Tiktok><svg version="1.0" xmlns="http://www.w3.org/2000/svg" fill="currentcolor" stroke-width="2" viewBox="0 0 76 76"><path d="M65.9 19.4c1.4.2 2.8.1 2.8.1s0 6.2.0 12.2c-6.3.0-12.1-2-16.8-5.4V51c.1 20-24.6 29.8-38.3 15.6-14.7-15.1-2.1-40.5 19-37.7v12.3c-9.5-3-17.2 8-11.2 15.9 5.8 7.7 18.3 3.6 18.3-6.1v-48.2c2.4.0 9.9.0 12.2.0v1.6c.7 7.4 6.1 13.4 13.3 15v0C65.4 19.3 65.6 19.4 65.9 19.4z"/></svg></a><a href=mailto:KalebHawkins@outlook.com target=_blank rel="noopener noreferrer me" title=Email><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div><small class=footer_copyright>Â© 2023 Kryotek.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel="noreferrer noopener">Hugo blog awesome</a>
theme on
<a href=https://gohugo.io target=_blank rel="noreferrer noopener">Hugo</a>.</small></footer><script src=https://KalebHawkins.github.io/KryoLogs/js/themeSwitchnMenu.min.2a402288242b6930b175a0722c267e2353055739b3975834df35e56d00dd8f50.js></script></body></html>